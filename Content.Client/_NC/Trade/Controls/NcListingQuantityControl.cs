using System.Linq;
using Robust.Client.AutoGenerated;
using Robust.Client.UserInterface;
using Robust.Client.UserInterface.Controls;
using Robust.Client.UserInterface.XAML;

namespace Content.Client._NC.Trade.Controls;

[GenerateTypedNameReferences]
public sealed partial class NcListingQuantityControl : BoxContainer
{
    private const int QtyMaxDigits = 6;

    private bool _enabled = true;
    private bool _suppressEditChange;
    private int _min;
    private int _max;
    private int _value;

    public event Action<int>? OnValueChanged;
    public event Action? OnEnter;

    public NcListingQuantityControl()
    {
        RobustXamlLoader.Load(this);

        MinusButton.OnPressed += _ =>
        {
            if (_enabled && _value > _min)
                SetValue(_value - 1);
        };

        PlusButton.OnPressed += _ =>
        {
            if (_enabled && _value < _max)
                SetValue(_value + 1);
        };

        QtyEdit.OnTextChanged += _ =>
        {
            if (!_enabled || _suppressEditChange)
                return;

            var digits = new string(QtyEdit.Text.Where(char.IsDigit).Take(QtyMaxDigits).ToArray());
            if (digits.Length == 0)
            {
                SetEditSafe(_value.ToString());
                return;
            }

            if (!int.TryParse(digits, out var v))
                v = _value;

            var clamped = Math.Clamp(v, _min, Math.Max(_min, _max));
            var newText = clamped.ToString();

            if (QtyEdit.Text != newText)
                SetEditSafe(newText);

            SetValue(clamped);
        };

        QtyEdit.OnTextEntered += _ =>
        {
            if (_enabled)
                OnEnter?.Invoke();
        };
    }

    public LineEdit Edit => QtyEdit;

    public int Value => _value;

    public void Configure(int minValue, int maxValue, int initialValue, bool enabled, string? disabledTooltip = null)
    {
        SetLimits(minValue, maxValue);
        SetEnabled(enabled, disabledTooltip);
        SetValue(initialValue, notify: false);
    }

    public void SetLimits(int minValue, int maxValue)
    {
        _min = minValue;
        _max = Math.Max(minValue, maxValue);

        // Keep current value valid.
        var clamped = Math.Clamp(_value, _min, _max);
        if (clamped != _value)
            SetValue(clamped);
        else
            UpdateButtonsState();
    }

    public void SetEnabled(bool enabled, string? disabledTooltip = null)
    {
        _enabled = enabled;
        MinusButton.Disabled = !enabled;
        PlusButton.Disabled = !enabled;
        QtyEdit.Editable = enabled;

        if (!enabled && disabledTooltip != null)
        {
            MinusButton.ToolTip = disabledTooltip;
            PlusButton.ToolTip = disabledTooltip;
            QtyEdit.ToolTip = disabledTooltip;
        }
        else
        {
            MinusButton.ToolTip = null;
            PlusButton.ToolTip = null;
            QtyEdit.ToolTip = null;
        }

        UpdateButtonsState();
    }

    public void SetValue(int value, bool notify = true)
    {
        var clamped = Math.Clamp(value, _min, _max);

        if (clamped == _value && QtyEdit.Text == clamped.ToString())
        {
            UpdateButtonsState();
            return;
        }

        _value = clamped;
        QtyLabel.Text = _value.ToString();

        var text = _value.ToString();
        if (QtyEdit.Text != text)
            SetEditSafe(text);

        UpdateButtonsState();

        if (notify)
            OnValueChanged?.Invoke(_value);
    }

    public bool IsEditing(IUserInterfaceManager ui) => ui.KeyboardFocused == QtyEdit;

    private void UpdateButtonsState()
    {
        var noQty = !_enabled || _max <= 0;
        MinusButton.Disabled = noQty || _value <= _min;
        PlusButton.Disabled = noQty || _value >= _max;
        QtyEdit.Editable = !noQty;
    }

    private void SetEditSafe(string text)
    {
        _suppressEditChange = true;
        QtyEdit.Text = text;
        QtyEdit.CursorPosition = QtyEdit.Text.Length;
        _suppressEditChange = false;
    }
}
